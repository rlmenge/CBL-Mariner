###################################### PATCH NOTICE #######################################

From Pawel Winogrodzki <pawelwi@microsoft.com>:

The patch below has been backported to CBL-Mariner's version of the code.
Retained original version in terms of code changes, only affected line numbers have been
modified in order to be able to apply the patch.

############################## ORIGINAL PATCH BELOW THIS LINE ##############################
commit 53d1b600123f4a8229a6bc43ffb27ebeaf9a4917
Author: Dimitri John Ledkov <xnox@ubuntu.com>
Date:   Wed Jul 22 11:31:43 2020 +0100

    linuxefi: fail kernel validation without shim protocol.
    
    If certificates that signed grub are installed into db, grub can be
    booted directly. It will then boot any kernel without signature
    validation. The booted kernel will think it was booted in secureboot
    mode and will implement lockdown, yet it could have been tampered.
    
    CVE-2020-15705
    
    Reported-by: Mathieu Trudel-Lapierre <cyphermox@ubuntu.com>
    Signed-off-by: Dimitri John Ledkov <xnox@ubuntu.com>

diff --git a/grub-core/loader/arm64/linux.c b/grub-core/loader/arm64/linux.c
index a1ac7a3..83b19b7 100644
--- a/grub-core/loader/arm64/linux.c
+++ b/grub-core/loader/arm64/linux.c
@@ -328,7 +328,7 @@ grub_cmd_linux (grub_command_t cmd __attribute__ ((unused)),
   grub_dprintf ("linux", "kernel @ %p\n", kernel_addr);
 
   rc = grub_linuxefi_secure_validate (kernel_addr, kernel_size);
-  if (rc < 0)
+  if (rc <= 0)
     {
       grub_error (GRUB_ERR_INVALID_COMMAND, N_("%s has invalid signature"), argv[0]);
       goto fail;
diff --git a/grub-core/loader/efi/chainloader.c b/grub-core/loader/efi/chainloader.c
index 80f4492..6e741f4 100644
--- a/grub-core/loader/efi/chainloader.c
+++ b/grub-core/loader/efi/chainloader.c
@@ -1084,6 +1084,7 @@ grub_cmd_chainloader (grub_command_t cmd __attribute__ ((unused)),
 
       return 0;
     }
+  // -1 fall-through to fail
 
 fail:
   if (dev)
diff --git a/grub-core/loader/efi/linux.c b/grub-core/loader/efi/linux.c
index 0622dfa..c42c47c 100644
--- a/grub-core/loader/efi/linux.c
+++ b/grub-core/loader/efi/linux.c
@@ -33,6 +33,7 @@ struct grub_efi_shim_lock
 };
 typedef struct grub_efi_shim_lock grub_efi_shim_lock_t;
 
+// Returns 1 on success, -1 on error, 0 when not available
 int
 grub_linuxefi_secure_validate (void *data, grub_uint32_t size)
 {
diff --git a/grub-core/loader/i386/efi/linux.c b/grub-core/loader/i386/efi/linux.c
index ea9f513..9318fdb 100644
--- a/grub-core/loader/i386/efi/linux.c
+++ b/grub-core/loader/i386/efi/linux.c
@@ -202,7 +202,7 @@ grub_cmd_linux (grub_command_t cmd __attribute__ ((unused)),
   grub_print_error();
 
   rc = grub_linuxefi_secure_validate (kernel, filelen);
-  if (rc < 0)
+  if (rc <= 0)
     {
       grub_error (GRUB_ERR_INVALID_COMMAND, N_("%s has invalid signature"),
 		  argv[0]);
